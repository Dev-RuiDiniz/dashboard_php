{% extends "base.html" %}
{% block content %}
<div class="page-header">
  <div>
    <h2 class="h4 mb-1">Histórico mensal — {{ period }}</h2>
    <p class="text-muted mb-0">KPIs congelados a partir do snapshot persistido.</p>
  </div>
  <div class="page-header-actions">
    <a class="btn btn-outline-secondary" href="/historico">Voltar ao histórico</a>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-3"><div class="card card-body"><div class="text-muted small">Famílias</div><div class="h3 mb-0">{{ kpis.families_attended }}</div></div></div>
  <div class="col-md-3"><div class="card card-body"><div class="text-muted small">Cestas</div><div class="h3 mb-0">{{ kpis.deliveries_count }}</div></div></div>
  <div class="col-md-3"><div class="card card-body"><div class="text-muted small">Crianças</div><div class="h3 mb-0">{{ kpis.children_count }}</div></div></div>
  <div class="col-md-3"><div class="card card-body"><div class="text-muted small">Encaminhamentos</div><div class="h3 mb-0">{{ kpis.referrals_count }}</div></div></div>
</div>

<div class="card card-body mb-3">
  {% if closure.official_pdf_path %}
    <div class="d-flex flex-wrap gap-2 mb-2">
      <a class="btn btn-primary" href="/admin/fechamento/{{ year }}/{{ month }}/relatorio-oficial.pdf">Baixar PDF oficial</a>
      {% if can_admin %}
        <a class="btn btn-outline-dark" href="/historico/{{ year }}/{{ month }}/snapshot.json">Baixar snapshot JSON</a>
      {% endif %}
    </div>
    <ul class="mb-0">
      <li>Assinado por: {{ closure.official_signed_by_user_id or 'N/D' }}</li>
      <li>Assinado em: {{ closure.official_signed_at or 'N/D' }}</li>
      <li>SHA256: <code>{{ closure.official_pdf_sha256 or 'N/D' }}</code></li>
    </ul>
  {% else %}
    <div class="alert alert-warning mb-2">Relatório oficial não gerado para este mês.</div>
    {% if can_admin %}
      <a class="btn btn-outline-primary" href="/admin/fechamento?month={{ month }}&year={{ year }}">Ir para geração em /admin/fechamento</a>
    {% endif %}
  {% endif %}
</div>

<div class="card card-body mb-3">
  <h3 class="h6">Comparativo (Chart.js)</h3>
  <p class="text-muted small">Período padrão: 12 meses até {{ period }}.</p>
  <div class="row g-2 mb-3">
    <div class="col-md-3"><label class="form-label">De (YYYY-MM)</label><input id="seriesFrom" class="form-control" value="{{ default_from }}" /></div>
    <div class="col-md-3"><label class="form-label">Até (YYYY-MM)</label><input id="seriesTo" class="form-control" value="{{ default_to }}" /></div>
    <div class="col-md-3 d-flex align-items-end"><button id="loadSeries" class="btn btn-outline-primary">Atualizar gráficos</button></div>
  </div>

  <div class="row g-3">
    <div class="col-12"><canvas id="familiesChart" height="90"></canvas></div>
    <div class="col-12"><canvas id="deliveriesChart" height="90"></canvas></div>
    <div class="col-12"><canvas id="childrenChart" height="90"></canvas></div>
    <div class="col-12" id="vulnerabilityChartWrapper">
      <canvas id="vulnerabilityChart" height="90"></canvas>
    </div>
    <div class="col-12 d-none" id="vulnerabilityUnavailable">
      <div class="alert alert-info">Tendência de vulnerabilidade não disponível para este período.</div>
    </div>
  </div>
</div>

{% if can_admin %}
<div class="card card-body">
  <h3 class="h6">Fontes de dados (admin)</h3>
  <p class="mb-0">Fonte utilizada neste mês: <code>{{ snapshot_source }}</code>.</p>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const charts = {};

  function renderLineChart(targetId, label, labels, values, color) {
    const existing = charts[targetId];
    if (existing) existing.destroy();
    charts[targetId] = new Chart(document.getElementById(targetId), {
      type: 'line',
      data: {
        labels,
        datasets: [{ label, data: values, borderColor: color, backgroundColor: color, tension: 0.25 }],
      },
      options: { responsive: true, plugins: { legend: { display: true } } }
    });
  }

  async function loadSeries() {
    const from = document.getElementById('seriesFrom').value;
    const to = document.getElementById('seriesTo').value;
    const response = await fetch(`/api/historico/series?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
    const payload = await response.json();

    renderLineChart('familiesChart', 'Famílias atendidas', payload.labels, payload.families_attended, '#0d6efd');
    renderLineChart('deliveriesChart', 'Cestas entregues', payload.labels, payload.deliveries_count, '#198754');
    renderLineChart('childrenChart', 'Crianças atendidas', payload.labels, payload.children_count, '#fd7e14');

    const vulnValues = payload.avg_vulnerability || [];
    const hasVulnData = vulnValues.some((value) => value !== null && value !== undefined);
    document.getElementById('vulnerabilityChartWrapper').classList.toggle('d-none', !hasVulnData);
    document.getElementById('vulnerabilityUnavailable').classList.toggle('d-none', hasVulnData);
    if (hasVulnData) {
      renderLineChart('vulnerabilityChart', 'Média de vulnerabilidade', payload.labels, vulnValues, '#6f42c1');
    }
  }

  document.getElementById('loadSeries').addEventListener('click', loadSeries);
  loadSeries();
</script>
{% endblock %}
